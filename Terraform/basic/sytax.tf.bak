# create 3 Ec2 instances named payment-system-0/1/2
resource "aws_instance" "myec2" {
  ami           = "ami-0c462b53550d4fca8"
  instance_type = "t3.micro"
  count         = 3

  tags = {
    Name = "payment-system-${count.index}"
  }
}

# create 3 IAM users named alice, bob, johncorner
variable "users" {
  type    = list(string)
  default = ["alice", "bob", "johncorner", "james", "mrA"]
}

resource "aws_iam_user" "this" {
  count = 3
  name  = var.users[count.index]
}

# conditional expression
variable "environment" {
  default = "production"
}

resource "aws_instance" "myec2" {
  ami           = "ami-0c462b53550d4fca8"
  instance_type = var.environment == "development" ? "t2.micro" : "m5.large"

  # instance_type = var.environment != "development" ? "t2.micro" :"m5.large" 
  # instance_type = var.environment == "production" && var.region == "us-east-1" ? "m5.large" : "t2.micro"
}


# locals
variable "tags" {
  type = map(string)
  default = {
    Team = "security-team"
  }
}

locals {
  default = {
    Team         = "security-teams"
    CreationDate = "date-${formatdate("DDMMYYYY", timestamp())}"
  }
}

# use locals
resource "aws_security_group" "sg_01" {
  name = "app_firewall"
  tags = local.default
}

resource "aws_security_group" "sg_02" {
  name = "db_firewall"
  tags = local.default
}

# splat expression
resource "aws_iam_user" "lb" {
  name  = "iamuser.${count.index}"
  count = 3
  path  = "/system/"
}

# output all lb's information
output "arns" {
  value = aws_iam_user.lb[*].arn
}

# for_each for list
variable "user_names" {
  type    = set(string)
  default = ["alice", "bob", "john", "james"]
}

resource "aws_iam_user" "this" {
  for_each = var.user_names

  # both "each.key" and "each.value" is correct in list background
  # "each.value" is general way
  name = each.value
}

# for_each for map
variable "my-map" {
  default = {
    key  = "value"
    key1 = "value1"
  }
}

resource "aws_instance" "web" {
  for_each      = var.my-map
  instance_type = "m3.micor"

  # use map's value
  ami = each.value

  tags = {
    # use map's key
    Name = each.key
  }
}
